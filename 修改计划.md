# StoryTime 开源改造计划（清理作业痕迹 & 打造可维护项目）

> 这份文档的目的：把当前仓库从“课程/小组项目形态”改造成**可以完整开源**的工程——任何人 clone 后都能理解、能跑起来、README 能直接看到前端效果，并且后续可以持续维护/接受贡献。

---

## 0. 开源改造目标（Definition of Done）

### 0.1 对外叙事（项目本身的意义）

建议对外描述统一为：
- **StoryTime**：面向儿童/家长/教育场景的“故事化学习”生成器。用户选择主题、年龄段、角色与语言，系统生成可视化的故事/教学内容（文本/图像/音频/视频），把抽象知识点变成可感知的叙事体验。

### 0.2 仓库层面的验收标准

P0（必须做到）：
- GitHub 首页（`README.md`）能直接看到**前端效果**（截图或 GIF），并包含 Quick Start。
- 仓库中**没有**课程/作业/小组编号等痕迹（命名、文案、包名、仓库名等）。
- 仓库中**没有**密钥/账号/私有 endpoint 等敏感信息；提供 `.env.example`。
- 默认开箱可运行：按文档步骤可在本机启动并访问 `http://localhost:8080/`。
- 明确 License，并补齐贡献与行为规范（至少 `LICENSE` + `CONTRIBUTING.md`）。

P1（强烈建议）：
- **无外部 Key** 也能跑通“演示流程”（`demo` profile：不调用外部 AI/S3，改用内置示例数据），方便他人预览 UI/交互。
- CI（GitHub Actions）自动跑 `./gradlew test`，保证 PR 不破坏主分支。

P2（可选增强）：
- 提供 Docker 一键启动（应用 + Postgres）。
- 提供公开 Demo（Render/Fly.io/自建）或录屏作为替代。

---

## 1. 现状快照（基于当前仓库）

### 1.1 技术栈与功能边界

- 后端：Spring Boot 3.x（Web/Thymeleaf/WebSocket）、MyBatis（为主）+ JPA（可评估是否保留）
- DB：PostgreSQL
- 外部能力：OpenAI / Stable Diffusion / Luma（可选）；S3（Vultr 对象存储，可选）
- 前端形态：服务端渲染（Thymeleaf），静态资源在 `src/main/resources/static/`

### 1.2 已经具备的“开源基础设施”（可在计划中标记为已完成）

- `docker-compose.yml`：本地 Postgres 一键启动
- `.env.example`：环境变量示例
- `src/main/resources/db/schema.sql` + `src/main/resources/application-local.properties`：本地 profile 自动初始化表结构
- `src/main/java/com/storytime/config/S3Config.java`：S3 凭证缺失不阻塞启动（仅降级功能）

### 1.3 目前仍明显影响“完整开源”的点（优先清理）

- 命名痕迹：包名/Gradle group/仓库命名可能带课程或小组信息（需要统一清理）
- 文档缺失：没有对外 `README.md`（看不到项目价值/效果/如何运行）
- 仓库卫生：可能包含构建产物/IDE 文件（如 `build/`、`.idea/`、`.gradle/`、`.DS_Store`）
- 页面文案痕迹：存在模板/复用残留（例如图标 alt 文案、关于页占位品牌、页脚死链等）
- 默认安全策略不清晰：当前 `application.properties` 排除了 `SecurityAutoConfiguration`（需要明确“为何禁用/如何启用/默认是否安全”）

---

## 2. 里程碑拆解（建议顺序）

### M0：冻结基线（P0）

目标：在开始大改名/重构前，先确保能构建、能启动、能跑测试，避免“边修边崩”。

- [ ] 跑一遍测试：`./gradlew test`
- [ ] 本地启动自检：`./gradlew bootRun --args='--spring.profiles.active=local'`
- [ ] 记录当前关键页面截图（给后续对比用）：`/`、`/education`、`/fairytale`、`/dashboard`

### M1：仓库清理 + 去作业痕迹（P0）

目标：看起来就是一个正常开源仓库，命名与文案统一，历史包袱最小化。

### M2：README/文档 + 前端效果展示（P0）

目标：GitHub 首页就能理解“这是做什么的、怎么跑、长什么样”。

### M3：无 Key 可演示（P1）

目标：他人不申请任何 API key 也能跑通“演示流程”，降低试用门槛（也是最能体现项目意义的点）。

### M4：工程化与社区化（P1）

目标：贡献友好、可持续维护：CI、模板、规范、版本发布。

### M5：发布与运营（P2）

目标：打 Tag、写 Release Notes、可选部署 Demo，提升传播效果。

---

## 3. 详细改造步骤（按里程碑展开）

### 3.1 M1：仓库清理 + 去作业痕迹（P0）

#### Step 1：清理仓库卫生（文件/目录/历史）

- [ ] 删除不应入库的文件（并在 `.gitignore` 中确认已覆盖）：
  - `build/`、`.idea/`、`.gradle/`、`.DS_Store`、`*.log`
- [ ] 检查是否有大文件（视频/GIF 可能超 50MB）：必要时用 Git LFS 或压缩/替换
- [ ] 统一换行/编码与基础风格：
  - 添加 `.editorconfig`（可选，但对开源协作很友好）
- [ ] 扫描敏感信息（含 git 历史）：
  - 关键词：`API_KEY`、`SECRET`、`TOKEN`、`PASSWORD`、`VULTR`、`OPENAI`
  - 如果历史里出现过密钥：用 `git filter-repo` 清理（需要谨慎，建议新仓库重放提交）

验收：
- `git status` 干净（无产物）
- 仓库 clone 后体积合理（建议 < 200MB，视资源而定）

#### Step 2：去“作业命名痕迹”（repo 名 / package / gradle group）

建议统一命名策略：
- Repo 名：`storytime` 或 `storytime-ai`（避免课程/小组后缀）
- Java 根包名：`com.storytime` 或 `io.github.<你的GitHub名>.storytime`
- Gradle `group`：与根包一致（例如 `com.storytime` 或 `io.github.<你的GitHub名>`）

执行清单：
- [ ] 改 `build.gradle`：`group = '...'`
- [ ] 改 Java package（建议用 IDE 的 Rename/Refactor，一次性迁移目录与 import）
  - `src/main/java/com/storytime/**`（或你的目标包名）→ 新包名目录
  - `src/test/java/com/storytime/**` 同步迁移
  - `@MapperScan("...repository")` 同步更新
  - MyBatis 注解 SQL 内的 `typeHandler=...UUIDTypeHandler` 字符串也要全局替换
- [ ] 改 `settings.gradle` 的 `rootProject.name`（如果需要）
- [ ] 全库搜索替换并人工复核：旧包名/组号/课程或作业字样等

验收：
- `./gradlew test` 通过
- 启动后页面可访问

#### Step 3：清理页面/文案中的模板残留（“肉眼看得出是作业”）

建议重点检查：
- `src/main/resources/templates/index.html`：修正图标 alt 文案（与 StoryTime 功能一致）
- `src/main/resources/templates/aboutUs.html`：去掉模板残留，改为 “About StoryTime”
- 页脚链接：要么补齐页面（如 `/privacy.html`、`/terms.html`、`/sitemap.html`），要么去掉链接

验收：
- 首页/关于页不出现其他项目名、不出现课程字样、不出现组号

---

### 3.2 M2：README/文档 + 前端效果展示（P0）

#### Step 4：补齐对外文档骨架（README 优先）

新增/完善文件建议：
- [ ] `README.md`（英文或中英双语都可，建议英文 + 链接到中文）
- [ ] `README.zh-CN.md`（可选但推荐）
- [ ] `LICENSE`（MIT/Apache-2.0 二选一最常见）
- [ ] `CONTRIBUTING.md`（如何跑、如何提 PR、代码风格、分支策略）
- [ ] `CODE_OF_CONDUCT.md`（可直接用 Contributor Covenant）
- [ ] `SECURITY.md`（安全漏洞上报方式）

`README.md` 建议结构（最重要的是“效果 + 一键运行”）：
1) 项目一句话简介（What）
2) Demo 动图/截图（前端效果）
3) Features（能做什么）
4) Tech Stack（用什么做的）
5) Quick Start（怎么跑起来）
6) Configuration（环境变量）
7) Architecture（模块/流程简图）
8) Roadmap（下一步想做什么）

#### Step 5：让 GitHub 首页“直接看到前端效果”

建议在仓库里新增一个专门放展示资源的目录：
- [ ] `docs/assets/`

建议准备的展示素材（按重要程度）：
- [ ] `docs/assets/demo.gif`：10–20 秒演示（首页 → 选择表单 → 展示结果）
- [ ] `docs/assets/home.png`：首页截图
- [ ] `docs/assets/education.png`：教育生成页截图
- [ ] `docs/assets/fairytale.png`：童话生成页截图
- [ ] `docs/assets/dashboard.png`：用户/历史页截图（如果有）

录制/导出建议：
- 先用 `local` 或后续的 `demo` profile 把页面跑起来
- 录屏后转 GIF（可选工具：`ffmpeg` + `gifsicle`），控制在 5–15MB，宽度 900–1200px
- README 顶部放一张 GIF，其它页面用静态截图即可（避免 README 过重）

可复制的 README 展示片段：
```md
## Demo

![StoryTime demo](docs/assets/demo.gif)
```

（可选）GitHub “Social Preview”：
- [ ] 输出一张 `1280x640` 的预览图（`docs/assets/social-preview.png`）
- [ ] 在 GitHub 仓库 Settings → Social preview 手动上传（这一步不在代码里完成）

验收：
- 打开仓库首页，不点任何链接就能看到 UI 效果（GIF/截图至少其一）

#### Step 6：补齐“可复现运行”的文档（与 README 对齐）

建议 README 给出两条路径：

路径 A：Docker 起 Postgres + 本地跑应用（最通用）
```bash
docker compose up -d
./gradlew bootRun --args='--spring.profiles.active=local'
```

路径 B：纯本机 Postgres（给习惯本地环境的人）
- 建库、配环境变量、启动

同时明确：
- 需要哪些环境变量（参考 `.env.example`）
- 哪些功能依赖外部 key（OpenAI/SD/Luma/S3），没配会怎样（降级/提示）

---

### 3.3 M3：无 Key 可演示（P1，强烈建议）

#### Step 7：引入 `demo` profile（不调用外部服务，走内置示例）

目标：让贡献者/评审无需申请 API key，也能体验完整 UI 流程。

实现建议（两种路线，择一即可）：

**方案 A：服务层 stub（推荐）**
- [ ] 新增 `application-demo.properties`
  - 关闭外部调用开关（例如 `feature.ai.enabled=false`、`feature.s3.enabled=false`）
- [ ] 在 `OpenAIService` / `StableDiffusionService` / `LumaService` / `AudioService` 中加开关：
  - demo 模式返回本地固定内容（文本/图片/音频/视频 URL 指向 `static/demo/**`）
- [ ] 在 `src/main/resources/static/demo/` 放入少量示例资源（可控体积）

**方案 B：Controller 级别 mock（改动小但不优雅）**
- Controller 检测 demo 模式，直接给模板塞入示例数据

验收：
- `./gradlew bootRun --args='--spring.profiles.active=demo'`
- 不配置任何外部 key，仍能在页面看到“生成结果”（来自示例资源）

#### Step 8：用户数据与隐私边界（开源必须说清）

- [ ] README 增加 “Data & Privacy”：
  - 本项目默认把哪些内容写入数据库（用户名/邮箱/生成记录等）
  - 是否会把用户输入发送到第三方（OpenAI/SD/Luma）
  - 本地 demo 模式不会发送任何外部请求

---

### 3.4 M4：工程化与社区化（P1）

#### Step 9：CI（GitHub Actions）与质量门禁

- [ ] 新增 `.github/workflows/ci.yml`：
  - `./gradlew test`
  - （可选）生成 Jacoco coverage 报告并上传 artifact
- [ ] 打开 Dependabot（`dependabot.yml`）自动提依赖升级 PR
- [ ] 如果有格式化/静态检查工具（Checkstyle/Spotless），在 CI 中跑（没有就先不引入）

验收：
- PR 打开后自动跑 CI，并在 README 顶部挂 build badge（可选）

#### Step 10：贡献体验（issue/PR 模板）

- [ ] `.github/ISSUE_TEMPLATE/bug_report.yml`
- [ ] `.github/ISSUE_TEMPLATE/feature_request.yml`
- [ ] `.github/pull_request_template.md`

#### Step 11：代码层面的“开源可维护性”清理（建议分批，不要一口吃完）

优先做“不会改变行为但提升可读性”的：
- [ ] 删除长期注释掉的大段代码（例如 `UserController.java` 里保留一套登录流程即可）
- [ ] 移除 `System.out.println`，统一用 `slf4j` 日志
- [ ] 明确异常边界：对外 API 调用失败返回可读错误（不要 500 + stacktrace）
- [ ] 统一配置项命名（`openai.api.key`、`stablediffusion.api.key`、`luma.api.key`）

---

### 3.5 M5：发布与运营（P2）

#### Step 12：版本化发布

- [ ] 新增 `CHANGELOG.md`（或 GitHub Releases 里维护）
- [ ] 打 `v1.0.0` tag
- [ ] Release 中放 demo GIF、运行截图、Quick Start

#### Step 13：（可选）在线 Demo

如果要部署公开 demo，建议：
- demo 模式部署（避免保存真实用户数据/避免消耗 API 额度）
- 明确数据会定期清理、不要输入敏感信息

---

## 4. 最终验收清单（提交前自查）

- [ ] `README.md` 顶部有 demo GIF/截图；包含 Quick Start
- [ ] 包名/仓库名/文案不出现组号/课程/作业字样
- [ ] `LICENSE` 已添加且与依赖/资源版权不冲突
- [ ] 没有密钥入库（含 git 历史）
- [ ] `./gradlew test` 通过；`./gradlew bootRun` 可启动
- [ ] demo profile（如果做了）无需外部 key 可演示
